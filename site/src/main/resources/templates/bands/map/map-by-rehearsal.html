<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="@{#{page.band-map.title} + ' - Brass Band Results'}">Band Map - Brass Band Results</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
</head>
<body>
<div layout:fragment="content">
    <h2 th:text="#{page.band-map.title}">Band Map</h2>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="'/bands/MAP" th:text="#{page.band-map.tab.rehearsal-day}">By Rehearsal Day</a>
        </li>
    </ul>
    <br/>

    <div class="tab-content">
        <div id="map" style="width: 100%; height: 800px"></div>
        <br/>
        <p th:text="#{page.band-map.rehearsals.prompt-1}">This map only shows bands where we have rehearsal days listed.</p>
        <p th:text="#{page.band-map.rehearsals.prompt-2}">Turn off the buttons below for days you are unavailable, this will remove bands that rehearse on those days.</p>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="mon" th:text="#{day.monday}">Monday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="tue" th:text="#{day.tuesday}">Tuesday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="wed" th:text="#{day.wednesday}">Wednesday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="thu" th:text="#{day.thursday}">Thursday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="fri" th:text="#{day.friday}">Friday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="sat" th:text="#{day.saturday}">Saturday</button>
        <button class="dayButton btn btn-sm btn-success" type="button" th:id="sun" th:text="#{day.sunday}">Sunday</button>
    </div>
</div>

<div layout:fragment="scriptfooter">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script>
        let markers = [];

        function buildIcons() {
            let icons = new Map();
            let basePath = "[[${STATIC_HOST} + '/map']]";
            icons.set('section.championship', L.icon({iconUrl: basePath + '/championship.png'}));
            icons.set('section.first', L.icon({iconUrl: basePath + '/first.png'}));
            icons.set('section.second', L.icon({iconUrl: basePath + '/second.png'}));
            icons.set('section.third', L.icon({iconUrl: basePath + '/third.png'}));
            icons.set('section.fourth', L.icon({iconUrl: basePath + '/fourth.png'}));
            icons.set('section.fifth', L.icon({iconUrl: basePath + '/fifth.png'}));
            icons.set('section.elite', L.icon({iconUrl: basePath + '/elite.png'}));
            icons.set('section.excellence', L.icon({iconUrl: basePath + '/excellence.png'}));
            icons.set('status.competing', L.icon({iconUrl: basePath + '/band.png'}));
            icons.set('status.scratch', L.icon({iconUrl: basePath + '/band.png'}));
            icons.set('status.extinct', L.icon({iconUrl: basePath + '/extinct.png'}));
            icons.set('status.youth', L.icon({iconUrl: basePath + '/youth.png'}));
            icons.set('section.youth', L.icon({iconUrl: basePath + '/youth.png'}));
            icons.set('status.non-competing', L.icon({iconUrl: basePath + '/non_competing.png'}));
            icons.set('status.wind-band', L.icon({iconUrl: basePath + '/non_competing.png'}));
            icons.set('status.salvation-army', L.icon({iconUrl: basePath + '/sa.png'}));
            icons.set('section.a-grade', L.icon({iconUrl: basePath + '/a_grade.png'}));
            icons.set('section.b-grade', L.icon({iconUrl: basePath + '/b_grade.png'}));
            icons.set('section.c-grade', L.icon({iconUrl: basePath + '/c_grade.png'}));
            icons.set('section.d-grade', L.icon({iconUrl: basePath + '/d_grade.png'}));

            return icons;
        }

        function onEachFeature(feature, layer) {
            layer.bindPopup('<b>' + feature.properties.name + '</b><br/><br/>[<a href="/bands/' + feature.properties.slug + '/">More Details</a>]');
        }
        function pointToLayer(feature, latlng) {
            let marker =  L.marker(latlng, {
                icon: icon_markers.get(feature.properties.type)
            });
            marker.bbr_props = feature.properties;
            markers.push(marker);
            return marker;
        }

        function populateBandsOnMap(data, bandsLayer){
            bandsLayer.addData(data);
        }

        let latitude = "53.703211";
        let longitude = "-1.511536";
        let mapZoom = "8";
        let map = L.map('map').setView([latitude, longitude], mapZoom);
        let icon_markers = buildIcons();
        let layers = {};

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        layers["base"] = L.geoJson(null, {
            onEachFeature: onEachFeature,
            pointToLayer: pointToLayer
        }).addTo(map);
        let url = '/bands/MAP/for-day/bands.json';
        fetch(url)
            .then(response => response.json())
            .then(json => populateBandsOnMap(json, layers["base"]));

        let typeButtons = document.querySelectorAll("button.dayButton");
        for (let i=0; i<typeButtons.length; i++) {
            let eachButton = typeButtons[i];
            eachButton.addEventListener("click", toggleDisplayFunction(eachButton));
        }

        function toggleMarkers() {
            let buttonsBinary = "";
            buttonsBinary += document.getElementById("mon").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("tue").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("wed").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("thu").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("fri").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("sat").classList.contains("btn-success") ? "1" : "0";
            buttonsBinary += document.getElementById("sun").classList.contains("btn-success") ? "1" : "0";
            for (let i in markers) {
                let marker = markers[i];
                marker._icon.style.display = '';
                let rehearsalsBinary = marker.bbr_props.rehearsals;

                let visible = true;
                for (let i=0;i<7;i++) {
                    let buttonValue = buttonsBinary[i];
                    let bandValue = rehearsalsBinary[i];

                    if (buttonValue === '0' && bandValue === '1') {
                        visible = false;
                    }
                }

                if (!visible) {
                    marker._icon.style.display = 'none';
                }
            }
        }

        function toggleDisplayFunction(button) {
            return function toggleTypeDisplay(ev) {
                if (button.classList.contains("btn-success")) {
                    button.classList.remove("btn-success");
                    button.classList.add("btn-outline-dark");
                    toggleMarkers();
                } else {
                    button.classList.remove("btn-outline-dark");
                    button.classList.add("btn-success");
                    toggleMarkers();
                }
                ev.preventDefault();
            }

        }
    </script>
</div>


</body>
</html>
